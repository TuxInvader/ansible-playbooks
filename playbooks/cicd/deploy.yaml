---
- hosts: cicd
  become: yes
  vars_files:
    - ~/ansible/vars/cicd.yaml
  vars:
    jenkins_hostname: "{{ cicd.jenkins.hostname }}"
    jenkins_http_port: "{{ cicd.jenkins.http_port }}"
    jenkins_url_prefix: "{{ cicd.jenkins.url_prefix }}"
    jenkins_admin_username: "{{ cicd.jenkins.admin_username }}" 
    jenkins_admin_password: "{{ cicd.jenkins.admin_password }}"
    #jenkins_admin_password_file: /var/lib/jenkins/secrets/initialAdminPassword
    #jenkins_updates_url: "{{ cicd.jenkins.updates_url }}"
    jenkins_version: "{{ cicd.jenkins.version }}"
    jenkins_plugins: 
      - sshd
      - ssh-credentials
      - branch-api
      - jackson2-api
      - blueocean-jwt
      - htmlpublisher
      - blueocean-rest-impl
      - bouncycastle-api
      - checks-api
      - credentials-binding
      - pipeline-model-extensions
      - github
      - ssh-steps
      - mailer
      - workflow-aggregator
      - ssh-slaves
      - handy-uri-templates-2-api
      - popper-api
      - apache-httpcomponents-client-4-api
      - workflow-support
      - jdk-tool
      - pipeline-model-api
      - caffeine-api
      - jaxb
      - gitea
      - pipeline-stage-tags-metadata
      - jquery3-api
      - workflow-multibranch
      - bootstrap4-api
      - token-macro
      - timestamper
      - workflow-api
      - echarts-api
      - plain-credentials
      - git-server
      - pubsub-light
      - jquery-detached
      - pipeline-rest-api
      - script-security
      - pipeline-stage-view
      - font-awesome-api
      - github-api
      - favorite
      - workflow-job
      - gradle
      - pipeline-input-step
      - momentjs
      - bootstrap5-api
      - display-url-api
      - resource-disposer
      - email-ext
      - jenkins-design-language
      - sse-gateway
      - blueocean-events
      - blueocean-github-pipeline
      - handlebars
      - blueocean-git-pipeline
      - blueocean-bitbucket-pipeline
      - blueocean-pipeline-api-impl
      - workflow-cps-global-lib
      - jjwt-api
      - blueocean-config
      - command-launcher
      - credentials
      - matrix-project
      - ws-cleanup
      - ldap
      - mapdb-api
      - blueocean-i18n
      - ace-editor
      - durable-task
      - blueocean-autofavorite
      - jsch
      - git-client
      - snakeyaml-api
      - junit
      - okhttp-api
      - blueocean-rest
      - authentication-tokens
      - blueocean
      - matrix-auth
      - workflow-scm-step
      - cloudbees-folder
      - popper2-api
      - variant
      - workflow-step-api
      - scm-api
      - blueocean-dashboard
      - ant
      - blueocean-pipeline-editor
      - pipeline-model-definition
      - cloudbees-bitbucket-branch-source
      - plugin-util-api
      - structs
      - pam-auth
      - github-branch-source
      - pipeline-graph-analysis
      - pipeline-github-lib
      - antisamy-markup-formatter
      - blueocean-core-js
      - git
      - trilead-api
      - docker-commons
      - build-timeout
      - blueocean-commons
      - blueocean-web
      - workflow-cps
      - lockable-resources
      - workflow-durable-task-step
      - pipeline-build-step
      - docker-workflow
      - blueocean-display-url
      - pipeline-stage-step
      - pipeline-model-declarative-agent
      - pipeline-milestone-step
      - blueocean-personalization
      - blueocean-pipeline-scm-api
      - workflow-basic-steps
    jenkins_plugins_state: latest


  tasks:

    - name: Update the package cache
      apt:
        update_cache: true
        cache_valid_time: 3600
        autoclean: true
        autoremove: true
        upgrade: true

    - name: Install Required Packages 
      apt:
        name:
          - mariadb-server
          - mariadb-client
          - openjdk-11-jre-headless
          - git
        state: latest

    - name: Run through the jenkins setup 
      import_role:
        name: geerlingguy.jenkins

    - name: Fix the Jenkins resource URL
      copy:
        content: |
          <?xml version='1.1' encoding='UTF-8'?>
          <jenkins.model.JenkinsLocationConfiguration>
          <adminAddress>address not configured yet &lt;nobody@nowhere&gt;</adminAddress>
          <jenkinsUrl>{{ cicd.jenkins.proxy_url |default('http://' ~ jenkins_hostname ~ ':' ~ jenkins_http_port ~ jenkins_url_prefix) }}</jenkinsUrl>
          </jenkins.model.JenkinsLocationConfiguration>
        dest: /var/lib/jenkins/jenkins.model.JenkinsLocationConfiguration.xml
        owner: jenkins
        group: jenkins

    - name: fix a defect to disable setup wizard
      jenkins_script:
        script: |
          import static jenkins.model.Jenkins.instance as jenkins
          import jenkins.install.InstallState
          if (!jenkins.installState.isSetupComplete()) {
            InstallState.INITIAL_SETUP_COMPLETED.initializeState()
          }
        user: "{{ jenkins_admin_username }}"
        password: "{{ jenkins_admin_password }}"

    - name: Disable Anonymous read access
      lineinfile:
        line: "   <denyAnonymousReadAccess>true</denyAnonymousReadAccess>"
        regexp: "   <denyAnonymousReadAccess>.*"
        path: /var/lib/jenkins/config.xml

    - name: Restart Jenkins
      service:
        name: jenkins
        state: restarted

- name: Install and setup the Gitea service
  import_playbook: gitea.yaml
